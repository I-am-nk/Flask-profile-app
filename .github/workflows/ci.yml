name: CI - Build, Scan and Push Image to ECR

# ----------------------------------------
# Trigger workflow on push to main branch
# ----------------------------------------
on:
  push:
    branches:
      - main
    paths-ignore:
      - deployment.yaml

# ----------------------------------------
# Required permissions for OIDC & repo write
# ----------------------------------------
permissions:
  id-token: write     # Needed for AWS OIDC authentication
  contents: write     # Needed to update & commit deployment.yaml

# ----------------------------------------
# Global Environment Variables
# ----------------------------------------
env:
  AWS_REGION: ap-south-1
  ECR_REPO: flask-app
  IMAGE_NAME: flask-app

# ----------------------------------------
# Job: Build, Scan & Push Docker Image
# ----------------------------------------
jobs:
  build-and-push:
    name: Build, Scan & Push Docker Image to ECR
    runs-on: ubuntu-latest

    steps:
    # ----------------------------------------
    # Step 1: Checkout source code
    # ----------------------------------------
    - name: Checkout the code
      uses: actions/checkout@v4

    # ----------------------------------------
    # Step 2: Configure AWS credentials using OIDC
    # ----------------------------------------
    - name: Configure AWS Credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v5
      with:
        role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-ecr-role
        aws-region: ${{ env.AWS_REGION }}

    # ----------------------------------------
    # Step 3: Login to Amazon ECR
    # ----------------------------------------
    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    # ----------------------------------------
    # Step 4: Generate image tag using Git commit SHA
    # ----------------------------------------
    - name: Set Image Tag
      run: echo "IMAGE_TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV

    # ----------------------------------------
    # Step 5: Build Docker image
    # ----------------------------------------
    - name: Build Docker Image
      run: |
        docker build -t $IMAGE_NAME:$IMAGE_TAG .

    # ----------------------------------------
    # Step 6: Scan Docker image using Trivy (LOCAL IMAGE)
    # ----------------------------------------
    - name: Trivy Image Scan
      uses: aquasecurity/trivy-action@0.33.1
      with:
        image-ref: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
        format: table
        severity: CRITICAL
        exit-code: 1

    # ----------------------------------------
    # Step 7: Tag Docker image for ECR
    # ----------------------------------------
    - name: Tag Docker Image
      run: |
        docker tag $IMAGE_NAME:$IMAGE_TAG \
        ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:$IMAGE_TAG

    # ----------------------------------------
    # Step 8: Push Docker image to ECR
    # ----------------------------------------
    - name: Push Image to ECR
      run: |
        docker push \
        ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:$IMAGE_TAG

    # ----------------------------------------
    # Step 9: Update deployment.yaml with new image tag
    # ----------------------------------------
    - name: Update deployment.yaml
      run: |
        sed -i.bak "s|image:.*|image: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPO }}:${IMAGE_TAG}|g" kubernetes/deployment.yaml
        rm kubernetes/deployment.yaml.bak

    # ----------------------------------------
    # Step 10: Commit & push updated deployment.yaml
    # ----------------------------------------
    - name: Commit and Push Deployment Update
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add kubernetes/deployment.yaml
        git commit -m "Update image tag to $IMAGE_TAG [skip ci]"
        git push
